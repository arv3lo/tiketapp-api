version: "3.8"
services:
  mongo1:
    image: mongo:8.0.5
    container_name: mongo1
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017:27017"
    environment:
      # This is the key fix: it tells MongoDB to advertise itself as localhost
      - MONGODB_ADVERTISED_HOSTNAME=localhost
    volumes:
      - mongo1-data:/data/db
  mongo2:
    image: mongo:8.0.5
    container_name: mongo2
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27018:27017"
    volumes:
      - mongo2-data:/data/db
  mongo3:
    image: mongo:8.0.5
    container_name: mongo3
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27019:27017"
    volumes:
      - mongo3-data:/data/db

  # mongo-init-replicaset:
  #   image: mongo:8.0.5
  #   container_name: mongo-init-replicaset
  #   depends_on:
  #     - mongo1
  #     - mongo2
  #     - mongo3
  #   command: >
  #     sh -c "sleep 10 && mongosh --host 127.0.0.1 --eval
  #     'rs.initiate({
  #       _id: \"rs0\",
  #       members: [
  #         {_id: 0, host: \"mongo1:27017\"},
  #         {_id: 1, host: \"mongo2:27017\"},
  #         {_id: 2, host: \"mongo3:27017\"}
  #       ]
  #     })'"
  #   networks:
  #     default:
  #       aliases:
  #         - mongo-init-replicaset

volumes:
  mongo1-data:
  mongo2-data:
  mongo3-data:
